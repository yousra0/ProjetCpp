#include "mainwindow.h"
#include "ui_mainwindow.h"
#include <QMessageBox>
#include<QIntValidator>
#include <QApplication>
#include<QSound>
#include<QDebug>
#include<QMediaPlayer>
#include <QPrinter>
#include <QTextStream>
#include <QTextDocument>
#include <QDataStream>
#include <QPrintDialog>
#include <QSqlQuery>
#include<QComboBox>
#include<QSaveFile>
#include<QBuffer>
#include<QFileDialog>
#include<QFile>
#include <QMessageBox>
#include <QDebug>
#include <QIntValidator>
#include <QSqlQueryModel>
#include <QtCharts>
#include <QChartView>
#include <QLineSeries>
#include<QDesktopServices>
#include<QUrl>
#include <QTextStream>
#include <QTextDocument>
#include <QtPrintSupport/QPrintDialog>
#include <QtPrintSupport/QPrinter>
#include <QtWidgets>
#include<QFileDialog>
#include "mainwindow.h"
#include "ui_mainwindow.h"
#include<QGraphicsView>
#include<QPdfWriter>
#include<QSqlQuery>
#include<QSystemTrayIcon>
#include <QtNetwork/QAbstractSocket>
#include <QtNetwork/QSslSocket>
#include<QUrlQuery>
#include<QJsonDocument>
#include<QJsonObject>
#include<QJsonArray>
#include <QDate>
#include <QTime>
#include<QSqlTableModel>
#include<QItemSelectionModel>
#include<QTableWidgetItem>
#include <QDesktopWidget>
#include <QCoreApplication>
#include <QDateEdit>
#include <QComboBox>
#include"smtp.h"
#include <QPixmap>
#include <QMediaPlayer>
#include <QTabWidget>
#include <QObject>
#include <QDialog>
#include <QValidator>
#include <QPropertyAnimation>
#include <QEasingCurve>
#include <QSequentialAnimationGroup>
#include <QState>
#include <QStateMachine>
#include <QSignalTransition>
#include <QPainter>
#include<QString>
#include<QStatusBar>
#include <QSound>
#include<QTimer>
#include<QDateTime>
 #include <QApplication>
#include<QMessageBox>
#include <QApplication>
#include<QIntValidator>
//#include<QIntValidator>
#include <QtWidgets>
#include <QtCore>
#include <QtGui>
#include <QtSql>
#include <QPdfWriter>
#include <QPainter>
#include <QFont>
#include <QFileDialog>
#include <QMessageBox>
#include <QDesktopServices>
#include<QMessageBox>
#include<QComboBox>
#include<QtCharts>
#include<QtCharts>
#include <QPrinter>
#include <QPainter>
#include <QPrintDialog>
#include <QTextDocument>
#include <QDialog>
#include <QSqlQuery>
#include <QSqlQueryModel>
#include <QSortFilterProxyModel>
#include <QTextTableFormat>
#include <QStandardItemModel>
#include <QSortFilterProxyModel>
#include <QTextTableFormat>
#include <QStandardItemModel>
#include <QDialog>
#include <QFileDialog>
//#include <QMediaPlayer>
//#include <QVideoWidget>
#include <QDialog>
#include <QDesktopWidget>
#include <QSettings>
#include <QPrinter>
#include <QTextStream>
#include <QFile>
#include <QDataStream>
#include <QTextDocument>
#include<QRegExpValidator>
#include "mainwindow.h"
#include "ui_mainwindow.h"
#include <QMessageBox>
#include<QIntValidator>
#include <QApplication>
#include<QSound>
#include<QDebug>
#include<QMediaPlayer>
#include <QPrinter>
#include <QTextStream>
#include <QTextDocument>
#include <QDataStream>
#include <QPrintDialog>
#include <QSqlQuery>
#include<QComboBox>
#include<QSaveFile>
#include<QBuffer>
#include<QFileDialog>
#include<QFile>
#include <QMessageBox>
#include <QDebug>
#include <QIntValidator>
#include <QSqlQueryModel>
#include <QtCharts>
#include <QChartView>
#include <QLineSeries>
#include<QDesktopServices>
#include<QUrl>
#include <QTextStream>
#include <QTextDocument>
#include <QtPrintSupport/QPrintDialog>
#include <QtPrintSupport/QPrinter>
#include <QtWidgets>
#include<QFileDialog>
#include "mainwindow.h"
#include "ui_mainwindow.h"
#include<QGraphicsView>
#include<QPdfWriter>
#include<QSqlQuery>
#include<QSystemTrayIcon>
#include <QtNetwork/QAbstractSocket>
#include <QtNetwork/QSslSocket>
#include<QUrlQuery>
#include<QJsonDocument>
#include<QJsonObject>
#include<QJsonArray>
#include <QDate>
#include <QTime>
#include<QSqlTableModel>
#include<QItemSelectionModel>
#include<QTableWidgetItem>
#include <QDesktopWidget>
#include <QCoreApplication>
#include <QDateEdit>
#include <QComboBox>
#include"smtp.h"
#include <QPixmap>
#include <QMediaPlayer>
#include <QTabWidget>
#include <QObject>
#include <QDialog>
#include <QValidator>
#include <QPropertyAnimation>
#include <QEasingCurve>
#include <QSequentialAnimationGroup>
#include <QState>
#include <QStateMachine>
#include <QSignalTransition>
#include <QPainter>
#include<QString>
#include<QStatusBar>
#include <QSound>
#include<QTimer>
#include<QDateTime>
 #include <QApplication>
#include <QSqlQuery>
#include <QSqlError>
#include <QDebug>
#include <QSqlQuery>


#include <QMessageBox>
#include<QIntValidator>
#include <QApplication>
#include<QSound>
#include<QDebug>
#include<QMediaPlayer>
#include <QPrinter>
#include <QTextStream>
#include <QTextDocument>
#include <QDataStream>
#include <QPrintDialog>
#include <QSqlQuery>
#include<QComboBox>
#include<QSaveFile>
#include<QBuffer>
#include<QFileDialog>
#include<QFile>
#include <QMessageBox>
#include <QDebug>
#include <QIntValidator>
#include <QSqlQueryModel>
#include <QtCharts>
#include <QChartView>
#include <QLineSeries>
#include<QDesktopServices>
#include<QUrl>
#include <QTextStream>
#include <QTextDocument>
#include <QtPrintSupport/QPrintDialog>
#include <QtPrintSupport/QPrinter>
#include <QtWidgets>
#include<QFileDialog>
#include "mainwindow.h"
#include "ui_mainwindow.h"
#include<QGraphicsView>
#include<QPdfWriter>
#include<QSqlQuery>
#include<QSystemTrayIcon>
#include <QtNetwork/QAbstractSocket>
#include <QtNetwork/QSslSocket>
#include<QUrlQuery>
#include<QJsonDocument>
#include<QJsonObject>
#include<QJsonArray>
#include <QDate>
#include <QTime>
#include<QSqlTableModel>
#include<QItemSelectionModel>
#include<QTableWidgetItem>
#include <QDesktopWidget>
#include <QCoreApplication>
#include <QDateEdit>
#include <QComboBox>
#include"smtp.h"
#include <QPixmap>
#include <QMediaPlayer>
#include <QTabWidget>
#include <QObject>
#include <QDialog>
#include <QValidator>
#include <QPropertyAnimation>
#include <QEasingCurve>
#include <QSequentialAnimationGroup>
#include <QState>
#include <QStateMachine>
#include <QSignalTransition>
#include <QPainter>
#include<QString>
#include<QStatusBar>
#include <QSound>
#include<QTimer>
#include<QDateTime>
 #include <QApplication>
#include <QSqlQuery>
#include <QSqlError>
#include <QDebug>
#include <QSqlQuery>
#include"smtp.h"

#include "exportexcelobject.h"
#include<QSqlQuery>
#include<QSystemTrayIcon>
#include <QtNetwork/QAbstractSocket>
#include <QtNetwork/QSslSocket>
#include<QUrlQuery>
#include<QJsonDocument>
#include<QJsonObject>
#include<QJsonArray>
#include "mainwindow.h"
#include "ui_mainwindow.h"
#include <QMessageBox>
#include<QIntValidator>
#include <QApplication>
#include<QSound>
#include<QDebug>
#include<QMediaPlayer>
#include <QPrinter>
#include <QTextStream>
#include <QTextDocument>
#include <QDataStream>
#include <QPrintDialog>
#include <QSqlQuery>
#include<QComboBox>
#include<QSaveFile>
#include<QBuffer>
#include<QFileDialog>
#include<QFile>
#include <QMessageBox>
#include <QDebug>
#include <QIntValidator>
#include <QSqlQueryModel>
#include <QtCharts>
#include <QChartView>
#include <QLineSeries>
#include<QDesktopServices>
#include<QUrl>
#include <QTextStream>
#include <QTextDocument>
#include <QtPrintSupport/QPrintDialog>
#include <QtPrintSupport/QPrinter>
#include <QtWidgets>
#include<QFileDialog>
#include "mainwindow.h"
#include "ui_mainwindow.h"
#include<QGraphicsView>
#include<QPdfWriter>
#include<QSqlQuery>
#include<QSystemTrayIcon>
#include <QtNetwork/QAbstractSocket>
#include <QtNetwork/QSslSocket>
#include<QUrlQuery>
#include<QJsonDocument>
#include<QJsonObject>
#include<QJsonArray>
#include <QDate>
#include <QTime>
#include<QSqlTableModel>
#include<QItemSelectionModel>
#include<QTableWidgetItem>
#include <QDesktopWidget>
#include <QCoreApplication>
#include <QDateEdit>
#include <QComboBox>
#include"smtp.h"
#include <QPixmap>
#include <QMediaPlayer>
#include <QTabWidget>
#include <QObject>
#include <QDialog>
#include <QValidator>
#include <QPropertyAnimation>
#include <QEasingCurve>
#include <QSequentialAnimationGroup>
#include <QState>
#include <QStateMachine>
#include <QSignalTransition>
#include <QPainter>
#include<QString>
#include<QStatusBar>
#include <QSound>
#include<QTimer>
#include<QDateTime>
 #include <QApplication>
MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
    , ui(new Ui::MainWindow)
{
    ui->setupUi(this);
    ui->leid->setValidator( new QIntValidator(0, 9999999, this));
    ui->dateaa->setValidator( new QIntValidator(0, 9999999, this));





    ui->tabequipement->setModel(E.afficher());
   connect(ui->sendBtn, SIGNAL(clicked()),this, SLOT(sendMail()));
       connect(ui->browseBtn, SIGNAL(clicked()), this, SLOT(browse()));
}

MainWindow::~MainWindow()
{
    delete ui;
}



void MainWindow::on_pb_ajouter_clicked()
{
    //Récupération des informations saisies dans les 4 champs
       int id=ui->leid->text().toInt();
       int dateA=ui->dateaa->text().toInt();
       QString nomE=ui->lenomE->text();
       QString statut=ui->lestatut->text();

       Equipement E(id,dateA,nomE,statut);

    //insérer l'objet equipement instancié dans la table equipement
    //et récupérer la valeur de retour de query.exec()
    bool test=E.ajouter();

    //si la requete executée => QMessageBox::information
    if(test)
    {
        QMessageBox::information(nullptr, QObject::tr("OK"),
                     QObject::tr("Ajout effectué\n"
                                 "Click Cancel to exit"), QMessageBox::Cancel);

        //Actualiser le tableau apres l'ajout
       ui->tabequipement->setModel(E.afficher());
    }
    //si la requete non exécuté => QMessageBox::critical
    else
    {
        QMessageBox::critical(nullptr, QObject::tr("NOT OK"),
                     QObject::tr("Ajout non effectué\n"
                                 "Click Cancel to exit"), QMessageBox::Cancel);
    }

}

void MainWindow::on_pb_supprimer_clicked()
{
    Equipement E1;
    E1.setid(ui->id_supp->text().toInt());

    bool test=E1.supprimer(E1.getid());

    if(test)
    {
        QMessageBox::information(nullptr, QObject::tr("OK"),
                     QObject::tr("Suppression effectué\n"
                                 "Click Cancel to exit"), QMessageBox::Cancel);

        //Actualiser le tableau apres la suppression
       ui->tabequipement->setModel(E1.afficher());
    }
    //si la requete non exécuté => QMessageBox::critical
    else
    {
        QMessageBox::critical(nullptr, QObject::tr("NOT OK"),
                     QObject::tr("Suppression non effectué\n"
                                 "Click Cancel to exit"), QMessageBox::Cancel);
    }
}
void MainWindow::on_pb_modifier_clicked()
{

        int id=ui->leid->text().toInt();
        int dateA=ui->dateaa->text().toInt();
        QString nomE=ui->lenomE->text();
        QString statut=ui->lestatut->text();



    Equipement E(id,dateA,nomE,statut);
    bool test=E.modifier(id);
    if(test){
    ui->tabequipement->setModel(E.afficher());}
    // Vérifier que l'identifiant saisi est valide
            if (id <= 0)
            {
                QMessageBox::warning(this, "Erreur", "Veuillez entrer une valeur numérique valide pour l'identifiant.");
                return;
            }
            // Vérifier que les champs obligatoires sont remplis
                if (dateA <=0|| nomE.isEmpty() ||statut.isEmpty() )
                {
                    QMessageBox::warning(this, "Erreur", "Veuillez remplir tous les champs obligatoires.");
                    return;
                }

            // Vérifier que l'identifiant existe dans la table
            QSqlQuery query;
            query.prepare("SELECT * FROM reservation WHERE id = :id");
            query.bindValue(":id", id);

            if (!query.exec())
            {
                QMessageBox::critical(this, "Erreur", "Une erreur s'est produite lors de la vérification de l'identifiant.");
                return;
            }
            if (!query.next())
            {
                QMessageBox::warning(this, "Attention", "L'identifiant à modifier n'existe pas dans la table.");
                return;
            }

            // Demander à l'utilisateur de confirmer la modification
            QMessageBox::StandardButton confirmUpdate = QMessageBox::question(this, "Confirmation",
                "Êtes-vous sûr de vouloir modifier cet enregistrement ?",
                QMessageBox::Yes|QMessageBox::No);

            if (confirmUpdate == QMessageBox::No) {
                return; // L'utilisateur a annulé la modification, sortir de la fonction
            }

            // Exécuter la requête SQL pour mettre à jour l'enregistrement

            query.prepare("UPDATE reservation SET dateA = :dateA, nom = :nom, prenom = :prenom ,marque = :marque, modele = :modele WHERE id = :id");
            query.bindValue(":id", id);
            query.bindValue(":dateA", dateA);
            query.bindValue(":nomE", nomE);
            query.bindValue(":statut", statut);



            if (query.exec())
            {
                QMessageBox::information(nullptr, QObject::tr("OK"),
                             QObject::tr("Modification effectuée\n"
                                         "Click Cancel to exit"), QMessageBox::Cancel);

                //Actualiser le tableau après la modification
                ui->tabequipement->setModel(E.afficher());
            }
            else
            {
                QMessageBox::critical(nullptr, QObject::tr("NOT OK"),
                             QObject::tr("Modification non effectuée\n"
                                         "Click Cancel to exit"), QMessageBox::Cancel);
            }
    }
void MainWindow::on_pushButton_rechercher_clicked()
{
    // Récupérer la valeur de recherche et supprimer les espaces inutiles
    QString valeur = ui->lerechercher->text().trimmed();

    // Vérifier si la valeur de recherche est vide
    if (valeur.isEmpty())
    {
        // Afficher un message d'erreur
        QMessageBox::warning(this, "Recherche", "Veuillez saisir une valeur de recherche.");
        // Quitter la fonction sans exécuter la recherche
        return;
    }

    // Appeler la fonction de recherche dans la classe Piste et récupérer le modèle de résultats
       QSqlQueryModel *model = E.rechercher(valeur);

    // Vérifier si aucun résultat n'a été trouvé
    if (model->rowCount() == 0)
    {
        // Afficher un message d'information
        QMessageBox::information(this, "Recherche", "AQucun résultat trouvé.");
    }
    else
    {
        // Créer un message avec le nombre de résultats trouvés
        QString message = QString("%1 résultat(s) trouvé(s).").arg(model->rowCount());
        // Afficher un message d'information avec le nombre de résultats trouvés
        QMessageBox::information(this, "Recherche", message);
        // Définir le modèle de résultats dans la table
        ui->tabequipement->setModel(model);
        // Trier les résultats par ordre croissant de l'id
        ui->tabequipement->sortByColumn(0, Qt::AscendingOrder);
    }
}
void MainWindow::on_pushButton_PDF_clicked()
{
    QString dir = QFileDialog::getExistingDirectory(this, tr("Open Directory"), "/home", QFileDialog::ShowDirsOnly | QFileDialog::DontResolveSymlinks);
    qDebug()<<dir;

    QPdfWriter pdf(dir+"/PdfList.pdf");
    QPainter painter(&pdf);

    int i = 4000;

    painter.drawPixmap(QRect(100,100,2000,2000),QPixmap("C:/Users/Admin/Desktop/msi.png"));
    painter.setPen(Qt::red);
    painter.setFont(QFont("Time New Roman", 25));
    painter.drawText(3000,1450,"Liste Des Vehicule");
    painter.setPen(Qt::black);
    painter.setFont(QFont("Time New Roman", 15));
    painter.drawRect(100,100,9400,2500);
    painter.drawRect(100,3000,9400,500);
    painter.setFont(QFont("Time New Roman", 10));
    painter.drawText(300,3300,"ID");
    painter.drawText(1500,3300,"Date A");
    painter.drawText(3000,3300,"Nom E");
    painter.drawText(4800,3300,"Statut");
    painter.drawText(6600,3300,"");
    painter.drawText(8400,3300,"");
    painter.drawText(10000,3300,"");

    painter.drawRect(100,3000,9400,10700);

    QTextDocument previewDoc;
    QString pdflist = QDate::currentDate().toString("'data_'MM_dd_yyyy'.txt'");
    QTextCursor cursor(&previewDoc);

    QSqlQuery query;
    query.prepare("SELECT * FROM equipement");
    query.exec();
    while (query.next())
    {
        painter.drawText(300,i,query.value(0).toString());
        painter.drawText(1500,i,query.value("dateA").toString());
        painter.drawText(3000,i,query.value("nomE").toString());
        painter.drawText(4800,i,query.value("statut").toString());

        i = i +500;
    }

    int reponse = QMessageBox::question(this, "Générer PDF", " PDF Enregistré ! Voulez Vous Affichez Le PDF ?", QMessageBox::Yes|QMessageBox::No);

    if (reponse == QMessageBox::Yes)
    {
        QDesktopServices::openUrl(QUrl::fromLocalFile(dir+"/PdfList.pdf"));
        painter.end();
    }
    else
    {
        painter.end();
    }
}


void MainWindow::on_triID_clicked()
{
    ui->tabequipement->setModel(E.triID());

}

void MainWindow::on_nom_az_clicked()
{
     ui->tabequipement->setModel(E.triNOM());
}

void MainWindow::on_nom_desc_clicked()
{
    ui->tabequipement->setModel(E.triNOMdesc());
}

void MainWindow::on_ID_desc_clicked()
{
    ui->tabequipement->setModel(E.triIDdesc());
}


void MainWindow::on_export_excel_clicked()
{
    QString fileName = QFileDialog::getSaveFileName(this, tr("Excel file"), qApp->applicationDirPath (),
                                                    tr("Excel Files (*.xls)"));
    if (fileName.isEmpty())
        return;

    ExportExcelObject obj(fileName, "mydata", ui->tabequipement);

    //colums to export
    obj.addField(0, "id", "char(20)");
    obj.addField(1, "nomE", "char(20)");
    obj.addField(2, "dateA", "char(20)");
    obj.addField(3, "statut", "char(20)");



    int retVal = obj.export2Excel();
    if( retVal > 0)
    {
        QMessageBox::information(this, tr("Done"),
                                 QString(tr("%1 records exported!")).arg(retVal)//fichier enregistré dans dossier debug(build)
                                 );
    }
}

void   MainWindow::on_sendBtn_clicked()
{
    Smtp* smtp = new Smtp("medchedly.bahles@esprit.tn","211JMT7058", "smtp.gmail.com",465);
    connect(smtp, SIGNAL(status(QString)), this, SLOT(mailSent(QString)));
   QStringList attachments;
     foreach(QString filename, files) {
         attachments << filename;
     }
    if( !files.isEmpty() )
        smtp->sendMail("chedlybahles12@gmail.com", ui->rcpt->text() , ui->subject->text(),ui->msg->toPlainText(),attachments);
    else
        smtp->sendMail("chedlybahles12@gmail.com", ui->rcpt->text() , ui->subject->text(),ui->msg->toPlainText(),attachments);

    ui->rcpt->setText("");
    ui->subject->setText("");
    ui->msg->setPlainText("");
    files.clear();


}
void MainWindow::on_browseBtn_clicked()
{

    files.clear();

    QFileDialog dialog(this);
    dialog.setDirectory(QDir::homePath());
    dialog.setFileMode(QFileDialog::ExistingFiles);

    if (dialog.exec())
        files = dialog.selectedFiles();

    QString fileListString;
    foreach(QString file,files)
        fileListString.append( "\"" + QFileInfo(file).fileName() + "\" " );


    ui->file->setText( fileListString );

}
void MainWindow::on_pushButton_7_clicked()
{
    QSqlQueryModel * model= new QSqlQueryModel();
                                    model->setQuery("SELECT type FROM equipement ");
                                    float e=model->rowCount();
                                    model->setQuery("SELECT dateA FROM equipement ");
                                    float ee=model->rowCount();
                                    float total=e+ee;
                                    QString a=QString("NumSerie"+QString::number((e*100)/total,'f',2)+"%" );
                                    QString b=QString("id"+QString::number((ee*100)/total,'f',2)+"%" );
                                    QPieSeries *series = new QPieSeries();
                                    series->append(a,e);
                                    series->append(b,ee);
                            if (e!=0)
                            {QPieSlice *slice = series->slices().at(0);
                             slice->setLabelVisible();
                             slice->setPen(QPen());}
                            if ( ee!=0)
                            {
                                     // Add label, explode and define brush for 2nd slice
                                     QPieSlice *slice1 = series->slices().at(1);
                                     //slice1->setExploded();
                                     slice1->setLabelVisible();
                            }
                                    // Create the chart widget
                                    QChart *chart = new QChart();
                                    // Add data to chart with title and hide legend
                                    chart->addSeries(series);
                                    chart->setTitle("Pourcentage des id et dateA : nombre total : "+ QString::number(total));
                                    chart->legend()->hide();
                                    // Used to display the chart
                                    QChartView *chartView = new QChartView(chart);
                                    chartView->setRenderHint(QPainter::Antialiasing);
                                    chartView->resize(1000,500);
                                    chartView->show();
}
